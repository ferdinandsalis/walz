name: Security Audit

on:
  schedule:
    # Run security audit every Monday at 9:00 AM Vienna time
    - cron: '0 7 * * 1'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'package*.json'
      - '.github/workflows/security.yml'

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        run: npm audit --audit-level=moderate
        
      - name: Check for vulnerabilities
        id: audit-check
        run: |
          if npm audit --audit-level=high --json > audit-results.json; then
            echo "No high/critical vulnerabilities found"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "High/critical vulnerabilities found"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: security-audit-results
          path: audit-results.json
          
      - name: Create issue for vulnerabilities
        if: steps.audit-check.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditResults = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
            
            const vulnerabilities = auditResults.vulnerabilities || {};
            const highCritical = Object.entries(vulnerabilities)
              .filter(([, vuln]) => ['high', 'critical'].includes(vuln.severity))
              .map(([name, vuln]) => `- **${name}**: ${vuln.severity} - ${vuln.title}`);
            
            if (highCritical.length > 0) {
              const title = `ðŸš¨ Security vulnerabilities detected - ${new Date().toISOString().split('T')[0]}`;
              const body = `## Security Audit Results
            
            The following high/critical security vulnerabilities were detected:
            
            ${highCritical.join('\n')}
            
            ## Action Required
            - Review each vulnerability
            - Update affected packages
            - Run \`npm audit fix\` if safe fixes are available
            - Consider alternative packages if no fixes are available
            
            ## Audit Details
            Run \`npm audit\` locally for detailed information.
            
            Auto-generated by security audit workflow.`;
            
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'high-priority', 'automated']
              });
            }

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: true